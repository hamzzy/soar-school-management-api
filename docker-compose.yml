version: '3.9'

services:
  mongo:
    image: mongo:7
    container_name: axion-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: axion-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: axion-api
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SERVICE_NAME: axion
      ENV: development
      USER_PORT: 5111
      MONGO_URI: mongodb://mongo:27017/axion
      CACHE_REDIS: redis://redis:6379
      CORTEX_REDIS: redis://redis:6379
      OYSTER_REDIS: redis://redis:6379
      LONG_TOKEN_SECRET: local_long_secret_change_me
      SHORT_TOKEN_SECRET: local_short_secret_change_me
      REFRESH_TOKEN_SECRET: local_refresh_secret_change_me
      ACCESS_TOKEN_TTL: 15m
      REFRESH_TOKEN_TTL: 30d
      NACL_SECRET: local_nacl_secret_change_me
      RATE_LIMIT_WINDOW_MS: 60000
      RATE_LIMIT_MAX: 120
      LOGIN_ATTEMPT_WINDOW_MS: 900000
      LOGIN_ATTEMPT_MAX: 5
      LOGIN_LOCK_MS: 900000
      CORS_ORIGINS: http://localhost:3000,http://localhost:5111
    ports:
      - "5111:5111"
    command: ["node", "index.js"]

volumes:
  mongo_data:
  redis_data:
